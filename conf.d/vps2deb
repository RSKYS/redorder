#!/bin/sh

# Copyright 2025, Pouria Rezaei <Pouria.rz@outlook.com>

# Part of RedOrder, handling Debian
# (Most-likely due me hating Ubuntu)

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 2 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License at <http://www.gnu.org/licenses/> for
# more details.

set -e

mirror="http://ftp.uk.debian.org"
version="bookworm"

if [ "$(id -u)" -ne 0 ]; then
	echo "This script must be run as root."
	exit 1
fi

# For some reason.. my method won't work with old env.
if [ ! "$(uname -r | cut -d. -f1)" -ge 6 ]; then
	echo "Sorry.. kernel is outdated for this script."
	exit 1
fi

if ! command -v wget >/dev/null 2>&1; then
	echo "This script requires wget."
	exit 1
fi

docker_install() {
	local ARCH VER VER_BX

	ARCH=$(uname -m)
	VER=$(wget -qO- https://download.docker.com/linux/static/stable/x86_64/ | \
          grep -oE 'docker-[0-9]+\.[0-9]+\.[0-9]+\.tgz' | \
          sort -V | tail -n1 | cut -d- -f2 | cut -d. -f1-3)

	VER_BX=$(wget -qO- https://api.github.com/repos/docker/buildx/releases/latest \
          | grep '"tag_name"' | cut -d'"' -f4)

	if [ ! "$ARCH" = "x86_64" ]; then
		echo "This package is only for $ARCH."
		exit 1
	fi

	rm -rf /tmp/* || true

	wget -q "https://download.docker.com/linux/static/stable/$ARCH/docker-${VER}.tgz" \
		-O /tmp/docker.tgz
	# Docker main
	tar xzf /tmp/docker.tgz -C /tmp
	install -m0755 /tmp/docker/* /usr/local/bin/

	wget \
     "https://github.com/docker/buildx/releases/download/$VER_BX/buildx-${VER_BX}.linux-amd64" \
	 	-O /tmp/docker-buildx
	install -m0755 /tmp/docker-buildx /usr/local/bin/docker-buildx

	cat > /etc/systemd/system/docker.service <<-EOF
	[Unit]
	Description=Docker Service
	After=network-online.target containerd.service

	[Service]
	Type=notify
	ExecStart=/usr/local/bin/dockerd
	Restart=always
	Delegate=yes

	[Install]
	WantedBy=multi-user.target

	EOF

	systemctl daemon-reload
	systemctl enable docker --now

	getent group docker >/dev/null || groupadd docker
	usermod -aG docker "$USER"
	sleep 5
}

if ! command -v docker >/dev/null 2>&1; then
	echo "Let me install docker ..."
	docker_install 2>/dev/null || exit 1
fi

if ! command -v rsync >/dev/null 2>&1 ; then
	echo "rsync required to install extracted Slackware tree."
	exit 1
fi

export PATH="/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin:/usr/games"

extract_and_prepare() {
	rm -rf /tmp/build /Debian
	mkdir -p /tmp/build /Debian
	# Extract base from Docker
	cat > /tmp/build/Dockerfile <<-INIT
	FROM debian:$version AS builder
	USER root

	RUN apt update && apt -y install debootstrap
	RUN mkdir -p /mnt && \
		debootstrap --arch amd64 \
		--include=sudo,vim,bash,ca-certificates,zstd \
		$version /mnt $mirror/debian

	FROM scratch
	COPY --from=builder /mnt /

	CMD ["/bin/bash"]
	INIT

	( cd /tmp/build
	if ! command -v docker-buildx >/dev/null 2>&1; then
		DOCKER_BUILDKIT=1 \
			docker build -t base_sys .
	else
		docker-buildx build -t base_sys . || \
			echo "This script need's buildx"
	fi )

	docker create --name deb_tmp base_sys
	docker export deb_tmp -o /tmp/base.tar
	docker rm -f deb_tmp
	docker rmi base_sys
	tar -xf /tmp/base.tar -C /Debian
	rm -f /tmp/base.tar

	echo "nameserver 1.1.1.1" > /Debian/etc/resolv.conf
}

backup_old_files() {
	cp -fL /etc/hostname /etc/localtime /Debian/etc/ \
		2>/dev/null || true
	cp -f /etc/fstab /Debian/etc/fstab
	cp -f /etc/default/grub /Debian/etc/default/grub
	# Backup the partitions scheme
	# sgdisk --backup='/tmp/partitions.map' $DISK
}

cleanup() {
	rm -rf /boot/efi/* 2>/dev/null || true
	rm -f /boot/* 2>/dev/null || true
	find / \( -type f -o -type d \) -exec chattr -i {} + 2>/dev/null || true
}

overwrite_system() {
	# Galactic smash
	rsync -aHAX --numeric-ids --delete-after --exclude=/dev/** --exclude=/home/** \
		--exclude=/proc/** --exclude=/sys/** --exclude=/Debian/** \
		--exclude=/efi/** --exclude=/boot/** --exclude=/tmp/** --exclude=/var/lib/systemd/** \
		/Debian/ / || true

	cleanup
	rm -rf /Debian >/dev/null 2>&1 || true

	cat > /etc/apt/sources.list <<-MGM
	deb $mirror/debian/ $version contrib main non-free non-free-firmware

	deb $mirror/debian/ ${version}-updates contrib main non-free non-free-firmware

	deb $mirror/debian/ ${version}-proposed-updates contrib main non-free non-free-firmware

	deb $mirror/debian/ ${version}-backports contrib main non-free non-free-firmware

	#deb $mirror/debian-security/ ${version}-security contrib main non-free non-free-firmware

	MGM
	unset mirror version

	# For locale
	cat > /etc/locale.gen <<-LCL
	en_GB.UTF-8 UTF-8
	en_US.UTF-8 UTF-8

	LCL

	update-ca-certificates
	export DEBIAN_FRONTEND=noninteractive

	# Not too raw.. I still want ubuntu stuff a bit
	apt update
	apt dist-upgrade --auto-remove -y

	apt install -y --reinstall \
		appstream apt-file at-spi2-core bash-completion bc \
		bcache-tools bolt btrfs-progs byobu command-not-found console-setup \
		cryptsetup cryptsetup-initramfs dbus-user-session dconf-gsettings-backend \
		e2fsprogs-l10n eatmydata ed efibootmgr eject ethtool base-files \
		exfatprogs file fonts-dejavu-core ftp gdisk gir1.2-packagekitglib-1.0 \
		gnome-keyring gnome-keyring-pkcs11 gnupg-l10n gpg-wks-client gpg-wks-server \
		gtk-update-icon-cache hdparm hicolor-icon-theme htop info \
		iptables iputils-ping irqbalance jq krb5-locales base-passwd \
		lshw lsof lvm2 man-db manpages mdadm modemmanager mokutil mtr-tiny multipath-tools \
		ncurses-term netcat-openbsd networkd-dispatcher ntfs-3g open-iscsi \
		os-prober p11-kit packagekit-tools pastebinit pinentry-curses \
		plymouth pollinate powermgmt-base psmisc publicsuffix neofetch \
		python3-babel python3-bcrypt python3-click systemd-sysv \
		python3-gdbm python3-hamcrest python3-keyring grub-efi-amd64 \
		python3-lazr.restfulclient python3-openssl python3-pip python3-rfc3987 \
		python3-rich python3-service-identity git curl \
		python3-twisted python3-uritemplate python3-venv python3-webcolors python3-zipp \
		rsync rsyslog sbsigntool screen sg3-utils openssh-server \
		sosreport squashfs-tools ssh-import-id \
		strace tcpdump telnet thermald thin-provisioning-tools time \
		udisks2 upower usb-modeswitch usb.ids usbutils usrmerge netplan.io \
		uuid-runtime wireless-regdb xauth xdg-user-dirs xfsprogs xml-core zerofree

	# Fixing shitty recommends/suggests better this way.
	apt purge openssh-server exim4-base --auto-remove -y || true
	apt install openssh-server -y

	# Installing kernel
	apt install -y  linux-image-amd64 linux-headers-amd64

	# Making sure one last time
	dpkg --configure -a
}

configure_network() {
	local dev ipaddr prefix gateway net_conf

	dev=$(ls /sys/class/net | grep -Ev '^(lo|docker|veth|br-|virbr|vmnet|zt|wg)' | head -n1)
	ipaddr=$(ip -4 -o addr show dev "$dev" scope global | awk '{print $4; exit}')
	gateway=$(ip -4 route show default | awk '/default/ {print $3; exit}')
	macaddr=$(cat /sys/class/net/"$dev"/address 2>/dev/null)
	net_conf="/etc/netplan/00_default.yaml"

	mkdir -p /etc/netplan
	rm -rf /etc/netplan/{.*,*} || true

	cat >"$net_conf" <<-EOF
	network:
	  version: 2
	  ethernets:
	    $dev:
	      match:
	        macaddress: "${macaddr}"
	      set-name: "${dev}"
	      addresses:
	        - ${ipaddr}
	      routes:
	        - to: 0.0.0.0/0
	          via: ${gateway}
	      nameservers:
	        addresses:
	          - 1.1.1.1
	      mtu: 1500
	EOF
	netplan generate
	netplan apply >/dev/null 2>&1 || true
	# SSH
	systemctl enable ssh sshd >/dev/null 2>&1 || true
}

configure_bootloader() {
	local root_dev needs_lvm2

	root_dev=$(findmnt -no SOURCE / 2>/dev/null)
	needs_lvm2=0

	if findmnt /efi >/dev/null 2>&1; then
		umount -l /efi
		rm -rf /efi
		sed -i 's/\/efi/\/boot\/efi/' /etc/fstab || true
	fi

	case $root_dev in
	/dev/mapper/*) needs_lvm2=1 ;;
	esac

	if [ $needs_lvm2 -eq 1 ] && [ -f /etc/lvm/lvm.conf ]; then
		sed -i.bak 's/use_lvmetad = 1/use_lvmetad = 0/g' /etc/lvm/lvm.conf 2>/dev/null
	fi

	grub-install --force --removable --target=x86_64-efi --efi-directory=/boot/efi 

	if [ -f /etc/lvm/lvm.conf.bak ]; then
		mv /etc/lvm/lvm.conf.bak /etc/lvm/lvm.conf 2>/dev/null
	fi
}

finalize() {
	if [ -d /etc/ssh/sshd_config.d ]; then
		printf 'PermitRootLogin yes\nPasswordAuthentication yes\n' > /etc/ssh/sshd_config.d/50-Debian.conf
	else
		if grep -q '^#PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null; then
			sed -i '/^#PermitRootLogin\s/s/.*/PermitRootLogin yes/' /etc/ssh/sshd_config 2>/dev/null
		else
			grep -q '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null || printf 'PermitRootLogin yes\n' >> /etc/ssh/sshd_config
		fi
	fi

	echo "\nneofetch\n" >> /etc/profile
	echo 'root:0v3rk1ll' | chpasswd

	grub-mkconfig -o /boot/grub/grub.cfg

	cat <<-EOF
	Hey there,
	This machine has been squashed with new Debian distro.

	Recommended actions (on the VM host console):
	# sync ; reboot -f

	After reboot you should be able to login as root with '0v3rk1ll'
	Change it later how you see it fit ;-)
	EOF
}

choose_option() {
	case "$1" in
		1|--debian)
			printf 'Installing Debian %s..\n' "$version"
			return 0
			;;
		*)
			return 1
			;;
	esac
}

show_menu() {
	cat <<-EOF
	Supported distributions:
	1) Debian $version    (--debian)

	Usage: $0 [option_number|--option_name]
	EOF
}

if [ -n "$1" ]; then
	if ! choose_option "$1"; then
		printf 'Invalid option: %s\n' "$1"
		show_menu
		exit 1
	fi
else
	choose_option 1
fi

cd /
extract_and_prepare
backup_old_files
overwrite_system
configure_network
configure_bootloader
finalize

unset mirror version
